---
- name: Configurer la seconde interface sur Debian via /etc/network/interfaces
  become: yes
  blockinfile:
    path: /etc/network/interfaces
    marker: "# {mark} ANSIBLE MANAGED BLOCK: Configuration de {{ network_2nd_interface.name }}"
    block: |
          auto {{ network_2nd_interface.name }}
          iface {{ network_2nd_interface.name }} inet {{ network_2nd_interface.method }}
              address {{ network_2nd_interface.address }}
              netmask {{ network_2nd_interface.netmask }}
          {% if network_2nd_interface.gateway is defined %}
              gateway {{ network_2nd_interface.gateway }}
          {% endif %}
          {% if network_2nd_interface.dns is defined %}
              dns-nameservers {{ network_2nd_interface.dns | join(' ') }}
          {% endif %}
  when: vm_os == "debian"

- name: Configurer la seconde interface sur Windows (Ethernet2) via PowerShell
  win_shell: |
    $interface = Get-NetAdapter -Name "{{ networkCard_name }}" -ErrorAction SilentlyContinue
    if ($interface) {
      # Optionnel : Supprimer les anciennes adresses IP
      Get-NetIPAddress -InterfaceAlias $interface.Name -ErrorAction SilentlyContinue | Remove-NetIPAddress -Confirm:$false
      # Appliquer la nouvelle configuration
      New-NetIPAddress -InterfaceAlias $interface.Name -IPAddress "{{ new_ip }}" -PrefixLength {{ prefix_length }} -DefaultGateway "{{ gateway }}"
    }
  when: network_2nd_interface.name == "Ethernet2"
